<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/htmx.org@2.0.3" integrity="sha384-0895/pl2MU10Hqc6jd4RvrthNlDiE9U1tWmX7WRESftEDRosgxNsQG/Ze9YMRzHq" crossorigin="anonymous"></script>
    <link href="/static/css/tailwind.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/static/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/static/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Color2Alpha" />
    <link rel="manifest" href="/static/favicon/site.webmanifest" />
    <title>Color2Alpha</title>
</head>
<body>
<nav class="flex items-center justify-between flex-wrap bg-slate-100 p-6 shadow-md">
    <a class="font-bold text-lg text-slate-800" href="/">ColorPicker</a>
</nav>

<section class="mx-auto p-6 bg-slate-200 flex flex-col items-center">
    <h1 class="text-2xl font-bold leading-tight pt-10 text-slate-900">Pick Any Color from Your Image</h1>
    <p class="text-slate-600 mt-2">Upload an image and hover over it to find the color of any pixel.</p>
    <input type='file' name='file' id='imgInput' accept='image/*' class="border rounded-lg p-2 w-full max-w-xs bg-white shadow-sm hover:border-slate-400 mt-4"/>
</section>

<div class="color-picker mt-6 flex flex-col md:flex-row md:space-x-8 w-full justify-center items-center space-y-4 md:space-y-0 pt-10">
    <!-- Image Upload and Preview Container -->
    <div class="image-container flex flex-col items-center">
        <!-- Image preview -->
        <div class="flex justify-center mt-4">
            <img src="/static/images/placeholder.svg" alt="Preview of uploaded image" id="imagePreview" class="max-w-[360px] sm:max-w-[480px] shadow-lg rounded-md border border-slate-300 cursor-pointer">
        </div>
    </div>

    <!-- Color Display Container -->
    <div class="color-display-container flex flex-col items-center md:items-start">
        <!-- Color preview square and instructions -->
        <div class="color-preview mt-4 flex flex-col items-center md:items-start pt-4">
            <p class="text-slate-700 text-center md:text-left" id="colorValueText">Hover over the image to see the color, click to save it.</p>
        </div>

        <!-- Color display formats -->
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md mt-4 md:mt-8">
            <h2 class="text-2xl font-bold mb-4 text-center md:text-left">Color Format Display</h2>

            <div class="flex items-center justify-center md:justify-start space-x-4 mb-4">
                <div class="w-16 h-16 rounded-md shadow-inner bg-[#3B82F6]" id="colorPreviewSquare"></div>
                <input type="color" value="#3B82F6" class="w-16 h-10" disabled>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="hex" class="block text-sm font-medium text-gray-700">Hexadecimal:</label>
                    <input id="hex" type="text" value="#3B82F6" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="rgb" class="block text-sm font-medium text-gray-700">RGB:</label>
                    <input id="rgb" type="text" value="rgb(59, 130, 246)" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="rgba" class="block text-sm font-medium text-gray-700">RGBA:</label>
                    <input id="rgba" type="text" value="rgba(59, 130, 246, 1)" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="hsl" class="block text-sm font-medium text-gray-700">HSL:</label>
                    <input id="hsl" type="text" value="hsl(217, 91%, 60%)" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    htmx.on('#form', 'htmx:xhr:progress', function(evt) {
        htmx.find('#progress').setAttribute('value', evt.detail.loaded/evt.detail.total * 100)
    });

    const imageInput = document.getElementById('imgInput')
    const imagePreviewElement = document.getElementById('imagePreview')

    const offScreenCanvas = document.createElement('canvas');
    const offScreenCanvasContext = offScreenCanvas.getContext('2d');

    let imageObject = null
    imageInput.addEventListener('change', (e) => {
        const reader = new FileReader()
        reader.readAsDataURL(imageInput.files[0])
        reader.onload = () => {
            const image = new Image()
            image.src = reader.result
            image.onload = () => {
                imagePreviewElement.src = image.src
                setupCanvas(image)
                imageObject = image
            }
        }
    });


    imagePreviewElement.addEventListener('mousemove', (e) => {
            if(!imageObject) {
                return
            }
            const target = e.target

            const rect = target.getBoundingClientRect()
            const x = e.clientX - rect.left
            const y = e.clientY - rect.top

            console.log(`${x}, ${y}`)

            const colorPreviewSquare = getColorPreviewSquare();

            colorPreviewSquare.style.top = `${e.clientY - 110}px`
            colorPreviewSquare.style.left = `${e.clientX - 50}px`

            const rgbaColor = convertPixelDataToRGBA(getPixelDataFromImageAtCoordinates(
                imageObject,
                x, y
            ));

            colorPreviewSquare.style.backgroundColor = rgbaColor
    })

    imagePreviewElement.addEventListener('mouseout', (e) => {
       removeColorPreviewSquare()
    });

    function createColorPreviewSquare() {
        const square = document.createElement('div')
        square.setAttribute('id', 'colorPreviewSquare')
        square.style.width = '100px'
        square.style.height = '100px'
        square.style.position = 'absolute'
        square.style.border = '2px solid'
        square.style.borderRadius = '2px'
        square.style.borderColor = '#000'
        document.body.appendChild(square)
        return square
    }

    function getColorPreviewSquare() {
        let findExistingSquare = document.querySelector('#colorPreviewSquare');
        if (!findExistingSquare) {
            findExistingSquare = createColorPreviewSquare();
        }
        return findExistingSquare
    }

    function removeColorPreviewSquare() {
        const square = document.querySelector('#colorPreviewSquare');
        if (square) {
            square.remove()
        }
    }

    function setupCanvas(img) {
        offScreenCanvas.width = img.width;
        offScreenCanvas.height = img.height;
        offScreenCanvasContext.drawImage(img, 0, 0, img.width, img.height);
    }

    function getPixelDataFromImageAtCoordinates(img, x, y) {
        const [previewWidth, previewHeight] = getPreviewImageSize();
        const scaleX = img.width / previewWidth;
        const scaleY = img.height / previewHeight;

        const realX = Math.floor(x * scaleX);
        const realY = Math.floor(y * scaleY);

        return offScreenCanvasContext.getImageData(realX, realY, 1, 1).data;
    }

    function convertPixelDataToRGBA(pixelData) {
        return `rgba(${pixelData[0]}, ${pixelData[1]}, ${pixelData[2]}, ${pixelData[3]})`;
    }


    function getPreviewImageSize() {
        return [imagePreviewElement.width, imagePreviewElement.height];
    }

</script>
</body>
</html>